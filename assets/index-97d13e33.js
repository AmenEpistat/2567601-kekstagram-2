(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))c(r);new MutationObserver(r=>{for(const n of r)if(n.type==="childList")for(const p of n.addedNodes)p.tagName==="LINK"&&p.rel==="modulepreload"&&c(p)}).observe(document,{childList:!0,subtree:!0});function o(r){const n={};return r.integrity&&(n.integrity=r.integrity),r.referrerPolicy&&(n.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?n.credentials="include":r.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function c(r){if(r.ep)return;r.ep=!0;const n=o(r);fetch(r.href,n)}})();const q=(e,t)=>{e.key==="Escape"&&t()},j=(e,t=!0)=>{t?e.classList.add("hidden"):e.classList.remove("hidden")};function ae(e,t=500){let o;return(...c)=>{clearTimeout(o),o=setTimeout(()=>e.apply(this,c),t)}}const K=document.querySelector(".img-upload__form"),y=K.querySelector(".img-upload__preview").querySelector("img"),ue=K.querySelectorAll(".effects__preview"),de=e=>{const t=e.target.files[0];if(!t)return;const o=URL.createObjectURL(t);y.src=o,ue.forEach(c=>{c.style.backgroundImage=`url(${o})`})},me=document.querySelector(".effects__list"),E=document.querySelector(".effect-level__value"),C=document.querySelector(".effect-level__slider"),H=document.querySelector(".img-upload__effect-level"),fe=document.getElementById("effect-none");let s="";noUiSlider.create(C,{range:{min:0,max:100},start:100,step:5,connect:"lower",format:{to:function(e){return Number.isInteger(e)?e.toFixed(0):e.toFixed(1)},from:function(e){return parseFloat(e)}}});const g=(e,t,o)=>{C.noUiSlider.updateOptions({range:{min:e,max:t},step:o,start:t})},z=e=>{switch(s){case"blur":y.style.filter=`${s}(${e}px)`;break;case"invert":y.style.filter=`${s}(${e}%)`;break;default:y.style.filter=`${s}(${e})`}},Z=()=>{y.style.filter="none",E.value="",j(H,!0),fe.checked=!0},pe={"effect-chrome":()=>{g(0,1,.1),s="grayscale"},"effect-sepia":()=>{g(0,1,.1),s="sepia"},"effect-marvin":()=>{g(0,100,1),s="invert"},"effect-phobos":()=>{g(0,3,.1),s="blur"},"effect-heat":()=>{g(1,3,.1),s="brightness"}};C.noUiSlider.on("update",()=>{E.value=C.noUiSlider.get(),z(E.value)});me.addEventListener("change",e=>{e.target.id!=="effect-none"?(j(H,!1),pe[e.target.id](),z(E.value)):Z()});const G={get:async()=>await(await fetch("https://31.javascript.htmlacademy.pro/kekstagram/data/")).json(),send:async e=>await(await fetch("https://31.javascript.htmlacademy.pro/kekstagram/",{method:"POST",body:e,headers:{}})).json()},U=25,ge=document.querySelector(".scale__control--bigger"),ye=document.querySelector(".scale__control--smaller"),F=document.querySelector(".scale__control--value"),he=document.querySelector(".img-upload__form"),J=he.querySelector(".img-upload__preview").querySelector("img"),Q=e=>{let o=parseInt(F.value,10)+U*e;o=Math.max(U,Math.min(o,100)),F.value=`${o}%`,J.style.transform=`scale(${o/100})`},_e=()=>{J.style.transform="scale(1)",F.value="100%"};ge.addEventListener("click",()=>{Q(1)});ye.addEventListener("click",()=>{Q(-1)});const l=document.querySelector(".img-upload__form"),T=l.querySelector(".img-upload__input"),W=l.querySelector(".img-upload__overlay"),X=document.querySelector("body"),Y=l.querySelector(".img-upload__cancel"),k=l.querySelector(".img-upload__submit"),I=l.querySelector(".text__hashtags"),$=l.querySelector(".text__description"),ve=document.querySelector("#error").content.querySelector(".error"),Se=document.querySelector("#success").content.querySelector(".success");let f,u="",i=null;const ee=()=>{W.classList.toggle("hidden"),X.classList.toggle("modal-open");const e=document.querySelector(".pictures");e&&e.classList.contains("hidden")&&e.classList.remove("hidden")};function S(){T.value="",I.value="",$.value="",u="",Z(),_e(),f.reset(),Y.removeEventListener("click",S),document.removeEventListener("keydown",te),document.removeEventListener("click",M),ee()}function te(e){i?q(e,w):document.activeElement!==I&&document.activeElement!==$&&q(e,S)}function M(e){!W.contains(e.target)&&e.target!==T&&!i&&S()}function w(){i&&(i.remove(),i=null),document.removeEventListener("keydown",oe),document.removeEventListener("click",ne),document.removeEventListener("click",M)}function oe(e){q(e,w)}function ne(e){i&&!i.querySelector(".success__inner, .error__inner").contains(e.target)&&w()}const O=e=>{const t=e.cloneNode(!0);X.append(t),i=t,t.classList.contains("hidden")&&t.classList.remove("hidden");const o=t.querySelector(".error__button")||t.querySelector(".success__button");o&&o.addEventListener("click",w),document.addEventListener("keydown",oe),document.addEventListener("click",ne)},Le=e=>{u="";const t=e.trim().split("");return!t||t.length<=140?!0:(u="Длина комментария должна быть не больше 140 символов",!1)},qe=e=>{u="";const t=e.toLowerCase().trim();if(!t)return!0;const o=t.split(/\s+/);return[{check:new Set(o).size!==o.length,error:"Хештеги не должны повторяться"},{check:o.some(n=>n.length>20),error:"Хештег не может быть больше 20 символов"},{check:o.length>5,error:"Нельзя указать больше 5 хештегов"},{check:o.some(n=>!/^#[a-zа-яё0-9]{1,19}$/i.test(n)),error:"Хэштег невалиден"}].every(n=>(n.check&&(u=n.error),!n.check))},Ee=async e=>{try{const t=new FormData(e);await G.send(t),S(),O(Se)}catch{O(ve)}finally{k.disabled=!1,k.textContent="Опубликовать"}},Ce=()=>{f=new Pristine(l,{classTo:"img-upload__field-wrapper",errorTextParent:"img-upload__field-wrapper",errorClass:"img-upload__field-wrapper--error"}),f.addValidator(I,qe,()=>u),f.addValidator($,Le,()=>u),l.addEventListener("submit",async e=>{e.preventDefault(),f.validate()&&(k.disabled=!0,k.textContent="Публикую...",Ee(l))})};T.addEventListener("change",e=>{f.reset(),ee(),de(e),Y.addEventListener("click",S),document.addEventListener("keydown",te),document.addEventListener("click",M)});Ce();const L={DEFAULT:"filter-default",RANDOM:"filter-random",DISCUSSED:"filter-discussed"},V=document.querySelector(".img-filters");let D=L.DEFAULT,h=[];const ke=ae(e=>{re(e)},500),be=()=>{let e=[];switch(D){case L.DEFAULT:e=h.slice();break;case L.RANDOM:e=h.slice().sort(()=>.5-Math.random()).slice(0,10);break;case L.DISCUSSED:e=h.slice().sort((t,o)=>o.comments.length-t.comments.length);break}ke(e)},we=e=>{const t=e.target.closest("button.img-filters__button");if(!t||t.id===D)return;const o=document.querySelector(".img-filters__button--active");o&&o.classList.remove("img-filters__button--active"),t.classList.add("img-filters__button--active"),D=t.id,be()},Pe=e=>{V.classList.remove("img-filters--inactive"),V.addEventListener("click",we),h=e,re(h)},x=document.querySelector(".pictures"),Fe=document.querySelector("#picture").content.querySelector(".picture"),De=document.querySelector("#data-error").content.querySelector(".data-error"),xe=document.querySelector("body");let b=[];const re=(e=b)=>{x.querySelectorAll(".picture").forEach(o=>o.remove());const t=document.createDocumentFragment();e.forEach(({id:o,url:c,description:r,likes:n,comments:p})=>{const m=Fe.cloneNode(!0);m.dataset.pictureId=o,m.querySelector("img").src=c,m.querySelector("img").alt=r,m.querySelector(".picture__comments").textContent=p.length,m.querySelector(".picture__likes").textContent=n,t.append(m)}),x.append(t)},Te=()=>{const e=De.cloneNode(!0);return xe.append(e),e},Ie=e=>{e.remove()},$e=async()=>{try{b=await G.get(),Pe(b)}catch{const t=Te();setTimeout(()=>Ie(t),5e3)}};$e();const B=5;let a=0,_=[];const N=document.querySelector(".big-picture"),P=N.querySelector(".social__comments"),Me=P.querySelector(".social__comment"),A=N.querySelector(".social__comment-count"),v=N.querySelector(".social__comments-loader"),Ne=e=>{const t=document.createDocumentFragment();e.forEach(o=>{const c=Me.cloneNode(!0);c.querySelector(".social__picture").src=o.avatar,c.querySelector(".social__picture").alt=o.name,c.querySelector(".social__text").textContent=o.message,t.appendChild(c)}),P.append(t)},ce=()=>{a===0&&(P.innerHTML="");const e=_.slice(a,a+B),t=e.length+a;Ne(e),A.querySelector(".social__comment-shown-count").textContent=`${t}`,A.querySelector(".social__comment-total-count").textContent=_.length,t>=_.length?v.classList.add("hidden"):v.classList.remove("hidden"),a+=B},se=()=>{ce()},Ue=e=>{_=e,a=0,v.classList.remove("hidden"),ce(),v.addEventListener("click",se)},Oe=()=>{P.innerHTML="",a=0,_=[],v.removeEventListener("click",se)},d=document.querySelector(".big-picture"),R=d.querySelector(".big-picture__img").querySelector("img"),Ve=d.querySelector(".likes-count"),Be=d.querySelector(".social__comment-shown-count"),Ae=d.querySelector(".social__caption"),Re=d.querySelector(".big-picture__cancel");function je(){ie()}const le=e=>{q(e,ie)};function ie(){d.classList.add("hidden"),document.body.classList.remove("modal-open"),document.removeEventListener("keydown",le),Oe()}const Ke=e=>{const t=b.find(o=>o.id===Number(e));R.src=t.url,R.alt=t.description,Ve.textContent=t.likes,Be.textContent=t.comments.length,Ae.textContent=t.description,Ue(t.comments),d.classList.remove("hidden"),document.body.classList.add("modal-open"),Re.addEventListener("click",je),document.addEventListener("keydown",le)};x.addEventListener("click",e=>{const t=e.target.closest(".picture");t&&Ke(t.dataset.pictureId)});
